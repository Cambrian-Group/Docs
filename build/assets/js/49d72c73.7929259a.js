"use strict";(self.webpackChunkcelo_docs=self.webpackChunkcelo_docs||[]).push([[446],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return h}});var o=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=o.createContext({}),s=function(e){var t=o.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=s(e.components);return o.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,l=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),u=s(a),h=n,m=u["".concat(l,".").concat(h)]||u[h]||d[h]||r;return a?o.createElement(m,i(i({ref:t},p),{},{components:a})):o.createElement(m,i({ref:t},p))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,i=new Array(r);i[0]=u;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:n,i[1]=c;for(var s=2;s<r;s++)i[s]=a[s];return o.createElement.apply(null,i)}return o.createElement.apply(null,a)}u.displayName="MDXCreateElement"},95956:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return c},contentTitle:function(){return l},metadata:function(){return s},toc:function(){return p},default:function(){return u}});var o=a(83117),n=a(80102),r=(a(67294),a(3905)),i=["components"],c={title:"Valora Accounts",description:"How Valora operates as a meta-transaction wallet to facilitate mobile payments."},l="Valora Accounts",s={unversionedId:"celo-codebase/protocol/identity/valora-accounts",id:"celo-codebase/protocol/identity/valora-accounts",title:"Valora Accounts",description:"How Valora operates as a meta-transaction wallet to facilitate mobile payments.",source:"@site/docs/celo-codebase/protocol/identity/valora-accounts.md",sourceDirName:"celo-codebase/protocol/identity",slug:"/celo-codebase/protocol/identity/valora-accounts",permalink:"/celo-codebase/protocol/identity/valora-accounts",editUrl:"https://github.com/celo-org/docs/edit/main/docs/celo-codebase/protocol/identity/valora-accounts.md",tags:[],version:"current",frontMatter:{title:"Valora Accounts",description:"How Valora operates as a meta-transaction wallet to facilitate mobile payments."},sidebar:"docs",previous:{title:"Celo Identity Overview",permalink:"/celo-codebase/protocol/identity"},next:{title:"Phone Number Privacy",permalink:"/celo-codebase/protocol/identity/phone-number-privacy"}},p=[{value:"Two Types of Accounts",id:"two-types-of-accounts",children:[],level:2},{value:"Benefits of a Meta-Transaction Wallet",id:"benefits-of-a-meta-transaction-wallet",children:[{value:"Separation of signer and payer",id:"separation-of-signer-and-payer",children:[],level:3},{value:"Fund Recovery",id:"fund-recovery",children:[],level:3}],level:2},{value:"For Wallet Developers",id:"for-wallet-developers",children:[],level:2},{value:"For Dapp Developers",id:"for-dapp-developers",children:[{value:"EIP-712",id:"eip-712",children:[],level:3}],level:2},{value:"Implementation",id:"implementation",children:[],level:2}],d={toc:p};function u(e){var t=e.components,a=(0,n.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"valora-accounts"},"Valora Accounts"),(0,r.kt)("p",null,"How Valora operates as a meta-transaction wallet to facilitate mobile payments."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"two-types-of-accounts"},"Two Types of Accounts"),(0,r.kt)("p",null,"Behind every Valora wallet are two types of accounts: an externally owned account (EOA) and a meta-transaction wallet (MTW). EOAs are what most people think of when they imagine a blockchain wallet. EOAs are comprised of an ECDSA public/private key pair from which the on-chain address is derived. With Valora, this EOA is generated and stored on the user's mobile device and backed up via the mnemonic phrase. A meta-transaction wallet on the other hand is a smart contract that can be used to interact with other smart contracts on behalf of an EOA. In this case you can think of the MTW as a proxy account and the EOA as the only controller of this account."),(0,r.kt)("h2",{id:"benefits-of-a-meta-transaction-wallet"},"Benefits of a Meta-Transaction Wallet"),(0,r.kt)("h3",{id:"separation-of-signer-and-payer"},"Separation of signer and payer"),(0,r.kt)("p",null,"When new users sign up with Valora, most wallets start with an empty balance. This makes it difficult for the user to verify their phone number as they need to pay for both the Celo transactions and the Attestation Service fees (",(0,r.kt)("a",{parentName:"p",href:"/celo-codebase/protocol/identity"},"see here for more details"),"). To make this experience more intuitive for new users, cLabs operates an ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/komenci/"},"onboarding service called Komenci")," that pays for the transactions on behalf of the user. It does this by first deploying a meta-transaction wallet contract and setting the Valora EOA address as the signer. At this point, the EOA can sign transactions and submit them to Komenci. Komenci will wrap the signed transaction into a meta-transaction, which it pays for and submits to the network."),(0,r.kt)("h3",{id:"fund-recovery"},"Fund Recovery"),(0,r.kt)("p",null,"Meta-transaction wallets can also be useful if a user ever loses their phone and backup recovery phrase. Any ERC20 tokens that the EOA has ",(0,r.kt)("a",{parentName:"p",href:"https://docs.openzeppelin.com/contracts/2.x/api/token/erc20#IERC20-approve-address-uint256-"},"approved")," their meta-transaction wallet to use, can be recovered. In the case of loss of EOA, a new EOA will be created and granted signer rights to the original MTW. This would allow the lost funds to still be accessed, even though the original EOA is unrecoverable. This recovery mechanism hasn't been rolled out yet, but is actively being worked on by cLabs."),(0,r.kt)("h2",{id:"for-wallet-developers"},"For Wallet Developers"),(0,r.kt)("p",null,"When performing a payment to a Valora wallet, it's important that the address that is receiving funds is the EOA, and not the MTW since funds in the MTW are not displayed or directly accessible to Valora users. To look up a wallet using a phone number:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Use ODIS to query the phone number pepper"),(0,r.kt)("li",{parentName:"ol"},"Use the phone number pepper to get the on-chain identifier"),(0,r.kt)("li",{parentName:"ol"},"Use the on-chain identifier to get the account address"),(0,r.kt)("li",{parentName:"ol"},"Use the account address to get the wallet address (EOA)")),(0,r.kt)("p",null,"The first two steps are covered extensively in ",(0,r.kt)("a",{parentName:"p",href:"/developer-guide/contractkit/odis"},"this guide"),"."),(0,r.kt)("p",null,"To get the account address (step 3) you can use the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/e6fdaf798a662ffe2c12f9a74b28e0fa1c1f8101/packages/sdk/contractkit/src/wrappers/Attestations.ts#L472"},"Attestation contract method ",(0,r.kt)("inlineCode",{parentName:"a"},"lookupAccountsForIdentifier")),"."),(0,r.kt)("p",null,"To get the wallet address from the account (step 4) you can use the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/e6fdaf798a662ffe2c12f9a74b28e0fa1c1f8101/packages/sdk/contractkit/src/wrappers/Accounts.ts#L318"},"Account contract method ",(0,r.kt)("inlineCode",{parentName:"a"},"getWalletAddress")),"."),(0,r.kt)("p",null,"It may also be necessary to lookup the data encryption key (ex. ",(0,r.kt)("a",{parentName:"p",href:"/celo-codebase/protocol/transactions/tx-comment-encryption"},"for comment encryption"),"). This key can similarly be queried with the account by using the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/e6fdaf798a662ffe2c12f9a74b28e0fa1c1f8101/packages/sdk/contractkit/src/wrappers/Accounts.ts#L310"},"Account contract method ",(0,r.kt)("inlineCode",{parentName:"a"},"getDataEncryptionKey")),"."),(0,r.kt)("p",null,"You can view a working example of this all tied together in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/cli/src/commands/identity/get-attestations.ts"},"the ",(0,r.kt)("inlineCode",{parentName:"a"},"celocli")," command ",(0,r.kt)("inlineCode",{parentName:"a"},"identity:get-attestations")),"."),(0,r.kt)("h2",{id:"for-dapp-developers"},"For Dapp Developers"),(0,r.kt)("h3",{id:"eip-712"},"EIP-712"),(0,r.kt)("p",null,"Since all Valora users will have the ability to use a meta-transaction wallet, it's important to keep in mind that transactions may originate from an EOA as well as a smart contract. If your contract relies upon EIP-712 signed typed data, be sure to also support typed data originating from contracts. This data doesn't need to be signed by the msg.sender since it's originating from a contract."),(0,r.kt)("h2",{id:"implementation"},"Implementation"),(0,r.kt)("p",null,"The implementation of Valora's meta-transaction wallet can be ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/common/MetaTransactionWallet.sol"},"found here"),"."))}u.isMDXComponent=!0}}]);