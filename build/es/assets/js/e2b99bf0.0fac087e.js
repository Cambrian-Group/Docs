"use strict";(self.webpackChunkcelo_docs=self.webpackChunkcelo_docs||[]).push([[5123],{3905:function(e,t,o){o.d(t,{Zo:function(){return d},kt:function(){return u}});var a=o(67294);function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function s(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){n(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function i(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},r=Object.keys(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var c=a.createContext({}),l=function(e){var t=a.useContext(c),o=t;return e&&(o="function"==typeof e?e(t):s(s({},t),e)),o},d=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var o=e.components,n=e.mdxType,r=e.originalType,c=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),h=l(o),u=n,m=h["".concat(c,".").concat(u)]||h[u]||p[u]||r;return o?a.createElement(m,s(s({ref:t},d),{},{components:o})):a.createElement(m,s({ref:t},d))}));function u(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=o.length,s=new Array(r);s[0]=h;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:n,s[1]=i;for(var l=2;l<r;l++)s[l]=o[l];return a.createElement.apply(null,s)}return a.createElement.apply(null,o)}h.displayName="MDXCreateElement"},11837:function(e,t,o){o.r(t),o.d(t,{frontMatter:function(){return i},contentTitle:function(){return c},metadata:function(){return l},toc:function(){return d},default:function(){return h}});var a=o(83117),n=o(80102),r=(o(67294),o(3905)),s=["components"],i={title:"Celo Custody Integrations",description:"Details for custodians, exchanges, and other services that intend to custody Celo assets such as Celo Dollar and CELO on behalf of a user.",slug:"/developer-guide/integrations/custody"},c="Custody",l={unversionedId:"developer-resources/integrations/custody",id:"developer-resources/integrations/custody",title:"Celo Custody Integrations",description:"Details for custodians, exchanges, and other services that intend to custody Celo assets such as Celo Dollar and CELO on behalf of a user.",source:"@site/docs/developer-resources/integrations/custody.md",sourceDirName:"developer-resources/integrations",slug:"/developer-guide/integrations/custody",permalink:"/es/developer-guide/integrations/custody",editUrl:"",tags:[],version:"current",frontMatter:{title:"Celo Custody Integrations",description:"Details for custodians, exchanges, and other services that intend to custody Celo assets such as Celo Dollar and CELO on behalf of a user.",slug:"/developer-guide/integrations/custody"}},d=[{value:"Custody Overview",id:"custody-overview",children:[],level:2},{value:"Balance Model",id:"balance-model",children:[],level:2},{value:"Transfers",id:"transfers",children:[],level:2},{value:"CELO State Machine",id:"celo-state-machine",children:[],level:2},{value:"Smart Contracts",id:"smart-contracts",children:[{value:"Accounts",id:"accounts",children:[],level:3},{value:"LockedGold",id:"lockedgold",children:[],level:3},{value:"Election",id:"election",children:[],level:3},{value:"ReleaseGold",id:"releasegold",children:[],level:3}],level:2},{value:"Other Balance Changing Operations",id:"other-balance-changing-operations",children:[],level:2},{value:"Useful Tools",id:"useful-tools",children:[],level:2}],p={toc:d};function h(e){var t=e.components,o=(0,n.Z)(e,s);return(0,r.kt)("wrapper",(0,a.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"custody"},"Custody"),(0,r.kt)("p",null,"Details for custodians, exchanges, and other services that intend to custody Celo assets such as Celo Dollar and CELO on behalf of a user."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"custody-overview"},"Custody Overview"),(0,r.kt)("p",null,'Generally speaking, custodying CELO, the native token on the Celo network, requires understanding the various states that CELO can exist in at any time. This is to provide useful services beyond custody such as allowing users to lock up their CELO and vote with it. Many of these "states" are implemented as smart contracts, and involve sending CELO from a user owned account to a contract address. Thus, in order to be able to show a user\'s true balance, services need to be able to observe every balance changing operation and reconcile CELO balances from all the various contracts and states CELO can be in.'),(0,r.kt)("h2",{id:"balance-model"},"Balance Model"),(0,r.kt)("p",null,"As a fork of Ethereum, Celo retains the account model to keep track of users' balances. Celo Dollar and CELO implement the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md"},"ERC20")," interface. As mentioned previously, it is common for smart contracts to hold balances on behalf of other addresses. One example is the ",(0,r.kt)("a",{parentName:"p",href:"/es/celo-codebase/protocol/proof-of-stake/locked-gold"},(0,r.kt)("inlineCode",{parentName:"a"},"LockedGold"))," smart contract that holds the \"locked portion of a user's ",(0,r.kt)("inlineCode",{parentName:"p"},"CELO"),' balance". Another one is the ',(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/ReleaseGold.sol"},(0,r.kt)("inlineCode",{parentName:"a"},"ReleaseGold"))," smart contract that holds ",(0,r.kt)("inlineCode",{parentName:"p"},"CELO")," that is being released to a beneficiary address over time according to some schedule."),(0,r.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Celo assets assets exist on an independent blockchain, and although they implement the ERC20 interface, they cannot be accessed through wallets that connect to the Ethereum network. Wallets and other integrations must connect to the Celo network to transfer tokens on Celo."))),(0,r.kt)("p",null,"Applications that display balances may need to be written to be aware of this possibility."),(0,r.kt)("h2",{id:"transfers"},"Transfers"),(0,r.kt)("p",null,"CELO and Celo Dollars implement the ERC20 interface, as will any future core stable Celo currencies. CELO, as the native currency of the network, can also be transferred by specifying the value field of a transaction, in the same way that ETH can be transferred in Ethereum. Therefore, for CELO, application developers should be aware that transactions can be specified in both ways."),(0,r.kt)("h2",{id:"celo-state-machine"},"CELO State Machine"),(0,r.kt)("p",null,"CELO as described previously can also exist in various states that represent a specific user behavior. For example, if a user wants to lock CELO to either participate in consensus directly or vote, that CELO will be sent to the ",(0,r.kt)("inlineCode",{parentName:"p"},"LockedGold")," smart contract. To understand the high level flow, please read ",(0,r.kt)("a",{parentName:"p",href:"/es/celo-codebase/protocol/proof-of-stake/locked-gold#locking-and-voting-flow"},"this description of the various states CELO can exist in"),"."),(0,r.kt)("h2",{id:"smart-contracts"},"Smart Contracts"),(0,r.kt)("p",null,"The following smart contracts are helpful to understand in order to map the conceptual states to actual accounts and function calls."),(0,r.kt)("h3",{id:"accounts"},"Accounts"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/common/Accounts.sol"},"Accounts.sol")," allows the mapping of an address to an account in storage, after which all further functionality (locking, voting, etc.) can be accessed."),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/common/Accounts.sol#L103"},(0,r.kt)("inlineCode",{parentName:"a"},"createAccount"))," function indexes the address as an account in storage, and is required to differentiate an arbitrary key-pair from a user-owned account in the Celo network."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"Accounts")," contract also allows for the authorization of various signer keys, such as a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/common/Accounts.sol#L175"},"vote signer key"),'. This allows for the user who owns the primary account key to authorize a separate key that can only vote on behalf of the account. This allows for the ability to custody keys in a manner corresponding to their exposure or "warmth". Eg. the primary account private key can be kept in cold storage after authorizing the signer keys, which can be in warmer environments, and potentially more exposed to the network. See the ',(0,r.kt)("a",{parentName:"p",href:"/es/validator-guide/summary/detailed"},"key management guide")," for more details."),(0,r.kt)("h3",{id:"lockedgold"},"LockedGold"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/LockedGold.sol"},"LockedGold.sol"),", which references Celo Gold, the deprecated name for the native token, is used as part of Celo's ",(0,r.kt)("a",{parentName:"p",href:"//celo-codebase/protocol/proof-of-stake"},"proof-of-stake")," mechanism. Users can lock CELO by sending it to the ",(0,r.kt)("inlineCode",{parentName:"p"},"LockedGold")," contract after creating an account via the ",(0,r.kt)("inlineCode",{parentName:"p"},"Accounts")," contract as described above. This allows users to vote in validator elections, receive epoch rewards, and participate in on-chain governance."),(0,r.kt)("p",null,"There are two ways in which users can vote:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Directly, by sending voting transactions with the same key used to lock up CELO"),(0,r.kt)("li",{parentName:"ul"},"Via an authorized vote signer, which can submit voting transactions on behalf of the account with locked CELO")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"LockedGold")," has a mapping of addresses to ",(0,r.kt)("inlineCode",{parentName:"p"},"balances")," which is a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/LockedGold.sol#L26"},"type")," that contains both the ",(0,r.kt)("inlineCode",{parentName:"p"},"nonvoting")," amount of CELO as well as ",(0,r.kt)("inlineCode",{parentName:"p"},"pendingWithdrawals"),", which contain values corresponding to timestamps at which they can be withdrawn. The reason for the latter is because all locked CELO has an unlocking period that is ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/LockedGold.sol#L78"},"set at time of contract initialization"),", which is 3 days in the Celo network's deployed ",(0,r.kt)("inlineCode",{parentName:"p"},"LockedGold")," contract. Hence, if users unlock CELO in tranches, multiple pending withdrawals could exist at once. Once the timestamp has eclipsed, CELO can be ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/LockedGold.sol#L193"},"withdrawn back to the user's address"),"."),(0,r.kt)("h3",{id:"election"},"Election"),(0,r.kt)("p",null,"Once CELO has been locked via ",(0,r.kt)("inlineCode",{parentName:"p"},"LockedGold"),", it can then be used to vote for validator groups. ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/Election.sol"},"Election.sol")," is the contract that manages this functionality."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"votes")," in this contract are tracked by a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/Election.sol#L87"},"Votes type")," which has ",(0,r.kt)("inlineCode",{parentName:"p"},"pending"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"active"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"total")," votes. Pending votes are those that have been cast for a validator group, and active votes are those that have been activated after an epoch, meaning that these votes generate voter rewards."),(0,r.kt)("p",null,"Votes are cast for a validator group using the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/Election.sol#L229"},(0,r.kt)("inlineCode",{parentName:"a"},"vote")," function"),". This increments the ",(0,r.kt)("inlineCode",{parentName:"p"},"pending")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"total")," votes in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Election")," contract, and decrements the equivalent amount of CELO from the ",(0,r.kt)("inlineCode",{parentName:"p"},"nonvoting")," balance in the ",(0,r.kt)("inlineCode",{parentName:"p"},"LockedGold")," contract, for the associated account."),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/Election.sol#L263"},(0,r.kt)("inlineCode",{parentName:"a"},"activate")," function")," can then be called to shift ",(0,r.kt)("inlineCode",{parentName:"p"},"pending")," votes into ",(0,r.kt)("inlineCode",{parentName:"p"},"active")," votes in a following epoch. Votes in either state can then be revoked, which decrements votes from the ",(0,r.kt)("inlineCode",{parentName:"p"},"Election")," contract and returns them to the ",(0,r.kt)("inlineCode",{parentName:"p"},"LockedGold")," balance for the associated account. Users can revoke votes at any time and this takes effect instantly."),(0,r.kt)("h3",{id:"releasegold"},"ReleaseGold"),(0,r.kt)("p",null,"A common problem in other proof-of-stake protocols is the tension between wanting early token holders' balances to release over time to ensure long-term alignment, while also wanting them to be able to participate in consensus to increase the security of the network. To bridge both goals, many early token balances in the Celo network are released via the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/ReleaseGold.sol"},(0,r.kt)("inlineCode",{parentName:"a"},"ReleaseGold")),' contract. Beneficiaries of these contracts can then participate in the proof-of-stake system by staking and voting with CELO that has not yet been "released" for transfers. Please find more high level information about the ',(0,r.kt)("inlineCode",{parentName:"p"},"ReleaseGold")," contract ",(0,r.kt)("a",{parentName:"p",href:"/es/celo-owner-guide/release-gold"},"here"),"."),(0,r.kt)("p",null,"From a technical perspective, ",(0,r.kt)("inlineCode",{parentName:"p"},"ReleaseGold"),' can be thought of as a "puppet" account controlled by the "puppeteer", or the beneficiary private key corresponding to the ',(0,r.kt)("inlineCode",{parentName:"p"},"beneficiary")," address in the contract. This beneficiary key can then authorize validator signer and vote signer keys that can then call respective functions associated with validating or voting. Most of the required function calls described above can be made by the signer keys directly to the ",(0,r.kt)("inlineCode",{parentName:"p"},"LockedGold")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"Election")," contracts associated with the ",(0,r.kt)("inlineCode",{parentName:"p"},"ReleaseGold")," account. However, some functions in the ",(0,r.kt)("inlineCode",{parentName:"p"},"ReleaseGold")," contract are proxied to the underlying ",(0,r.kt)("inlineCode",{parentName:"p"},"LockedGold")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"Election")," contracts, and have a separate function signature that can be called by the ",(0,r.kt)("inlineCode",{parentName:"p"},"beneficiary")," address. Notably:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/ReleaseGold.sol#L669"},(0,r.kt)("inlineCode",{parentName:"a"},"createAccount"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/ReleaseGold.sol#L525"},(0,r.kt)("inlineCode",{parentName:"a"},"authorizeVoteSigner"))," and similar functions for other signer keys"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/ReleaseGold.sol#L469"},(0,r.kt)("inlineCode",{parentName:"a"},"lockGold"))," and ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/celo-org/celo-monorepo/blob/master/packages/protocol/contracts/governance/ReleaseGold.sol#L477"},(0,r.kt)("inlineCode",{parentName:"a"},"unlockGold")))),(0,r.kt)("p",null,"Notice that all these functions have corresponding functions that are called on the underlying contract. The ",(0,r.kt)("inlineCode",{parentName:"p"},"ReleaseGold")," contract can then just be thought of as brokering the transaction to the correct place, when necessary."),(0,r.kt)("h2",{id:"other-balance-changing-operations"},"Other Balance Changing Operations"),(0,r.kt)("p",null,"In addition to transfers (both native and ERC-20) and locking / voting flows affecting user balances, there are also several additional Celo network features that may cause user balances to change:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Gas fee payments: the fee paid by transaction senders to use the network"),(0,r.kt)("li",{parentName:"ul"},"Tobin tax: a tax on CELO transfers when the reserve balance is low and needs to be repleted"),(0,r.kt)("li",{parentName:"ul"},"Epoch rewards distribution: reward payments to voters, validators, and validator groups")),(0,r.kt)("p",null,"Some of these may occur as events rather than transactions on the network, and therefore when updating balances, special attention should be paid to them."),(0,r.kt)("h2",{id:"useful-tools"},"Useful Tools"),(0,r.kt)("p",null,"Since monitoring balance changing operations is important to be able to display user balances properly, it can be helpful to use a tracing or reconciling system. ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/celo-org/rosetta"},"Celo Rosetta")," is an RPC server that exposes an API to query the Celo blockchain, obtain balance changing operations, and construct airgapped transactions. With a special focus on getting balance change operations, Celo Rosetta provides an easy way to obtain changes that are not easily queryable using the celo-blockchain RPC."))}h.isMDXComponent=!0}}]);